# Dev Session Notes - December 17, 2025

## Project Context
- **Frontend:** `~/Downloads/gambino-backend-backup-local/gambino-admin-v2` → Git → Vercel
- **Backend:** `nhac@192.168.1.235:/opt/gambino/backend` → PM2
- **Database:** MongoDB in Docker (`gambino_mongodb`)
- **MongoDB Connection:** `docker exec gambino_mongodb mongosh "mongodb://gambinouser:jhI%2BPDopCbhL%2FuAwniiKU2DSQX6Rv8LEXR5smWQZfIU%3D@localhost:27017/gambino?authSource=admin"`

## Work Completed

### 1. Machine Breakdown by Pi Hub (Store Page)
**Goal:** Group machines by Pi hub with collapsible dropdowns on store detail page

**Status:** Frontend code exists, backend endpoint added

**Files Changed:**
- Backend: `/opt/gambino/backend/src/routes/admin/reports.js`
  - Added `GET /:storeId/machine-hub-mapping` endpoint
  - Uses Events collection to map `gamingMachineId` → `hubMachineId`

**Key Discovery:**
- DailyReports don't have `hubId` populated (all undefined)
- Machine collection uses different IDs than DailyReports (`pi-001_machine_30` vs `machine_30`)
- Events collection HAS the mapping: `hubMachineId` (pi hub) + `gamingMachineId` (machine)

**Frontend Location:** `src/app/admin/stores/[id]/page.tsx`
- Lines 209-227: `getMachinesByHub()` function
- Lines 928-1122: Machine Breakdown UI section
- State: `hubs`, `machineHubMapping`, `expandedHubs`

### 2. Name Column on Hubs Page
**Goal:** Add human-given name column to Pi Hubs list

**Status:** ✅ Deployed to production

**Commit:** `6b23184`

**File:** `src/app/admin/hubs/page.tsx`
- Added `name` to Hub interface
- Added Name column to desktop table
- Added name display to mobile cards
- Added Name to sort options

## Backups Created
- Backend: `/opt/gambino/backend/src/routes/admin/reports.js.backup-*`
- Frontend: `src/app/admin/stores/[id]/page.tsx.backup-20251217_115238`

## Useful Commands

```bash
# SSH to backend server
ssh nhac@192.168.1.235

# Restart backend
ssh nhac@192.168.1.235 "pm2 restart gambino-backend"

# Check PM2 logs
ssh nhac@192.168.1.235 "pm2 logs gambino-backend --lines 20 --nostream"

# Start local frontend dev server
cd ~/Downloads/gambino-backend-backup-local/gambino-admin-v2
source ~/.nvm/nvm.sh && nvm use 20 && npm run dev

# MongoDB query example
ssh nhac@192.168.1.235 'docker exec gambino_mongodb mongosh "mongodb://gambinouser:jhI%2BPDopCbhL%2FuAwniiKU2DSQX6Rv8LEXR5smWQZfIU%3D@localhost:27017/gambino?authSource=admin" --quiet --eval "db.events.find({storeId: \"richmond_hotstreak_462\"}).limit(5).forEach(printjson)"'
```

## TODO / Follow-up
- [ ] Test machine-hub grouping on a store with actual data
- [ ] Verify richmond_hotstreak_462 store gets DailyReports with hubId in future
- [ ] Consider adding hub names to Hub collection for better display names
